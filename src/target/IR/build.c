#include <stdio.h>
#include <api.h>

// TODO: Move all instances of this to a non-arch specific utils file
static char size_as_char(Type type) {
    if      (type == Bits8) return 'b';
    else if (type == Bits16) return 'h';
    else if (type == Bits32) return 'w';
    else return 'l';
}

void build_function(Function IR, FILE *outf) {
    fprintf(outf, "%sfunction %c $%s(", (IR.is_global) ? "export " : "", size_as_char(IR.return_type), IR.name);
    for (size_t arg = 0; arg < IR.num_args; arg++) {
        fprintf(outf, "%c %%%s", size_as_char(IR.args[arg].type), IR.args[arg].label);
        if (arg != IR.num_args - 1)
            fprintf(outf, ", ");
    }
    fprintf(outf, ") {\n");
    for (size_t s = 0; s < IR.num_statements; s++) {
        if (IR.statements[s].label) {
            fprintf(outf, "\t%%%s =%c ", IR.statements[s].label, size_as_char(IR.statements[s].type));
        } else {
            fprintf(outf, "\t");
        }
        instructions_IR[IR.statements[s].instruction](IR.statements[s].vals, IR.statements[s].val_types, IR.statements[s], outf);
    }
    fprintf(outf, "}\n\n");
}

void build_program_IR(Function *IR, size_t num_functions, Global *global_vars, size_t num_global_vars, FILE *outf) {
    fprintf(outf, "# Generated by UYB for UYB IR\n\n");
    for (size_t f = 0; f < num_functions; f++) {
        build_function(IR[f], outf);
    }
}
